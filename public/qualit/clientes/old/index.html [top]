<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="../img/icon.png" rel="shortcut icon" type="image/x-icon" >
	<link href="../css/css.css" rel="stylesheet"     type="text/css">
	<script src="../js/js.js"></script>
    <title>USU√ÅRIOS</title>
    <style>
        .container { display: flex; gap: 20px; }
        .column { flex: 1; }
        table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    </style>
</head>
<body>
    <header>
		<img src="../img/logo.png" width="200" alt="Logo da Empresa">
		<h2>USU√ÅRIOS</h2>
	
    </header>

    <footer>
        <span id="dateTime"></span>
    </footer>
	<main>
	<BR/>
    <input type="text" id="Pesquisar" placeholder="üîé Pesquisar..."  onkeyup="Pesquisar()">
	<a href="javascript:window.history.back()"><button>VOLTAR üîô</button></a>
	
	
	<div id="loader">
		<img src="../img/loading.gif" alt="Carregando...">
	</div>
	<BR><BR>
    Nome do Cliente:<input type="text" id="cliente" placeholder="Nome do Cliente" class="input_login">
    <div class="container">
        <div class="column" id="nichos"></div>
        <div class="column" id="situacoes"></div>
        <div class="column" id="canais"></div>
        <div class="column" id="status"></div>
    </div>
    <button onclick="salvarCliente()">Salvar Cliente</button>
    
    <h3>Clientes Cadastrados</h3>
    <table>
        <thead>
            <tr>
                <th>Cliente</th><th>Nichos</th><th>Situa√ß√µes</th><th>Canais</th><th>Status</th><th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="clientes"></tbody>
    </table>

    <script>
        let clienteEditando = null; // Vari√°vel para controlar a edi√ß√£o

        async function fetchOptions(url, containerId, key) {
            const response = await fetch(url);
            const data = await response.json();
            const container = document.getElementById(containerId);
            container.innerHTML = `<h4>${containerId.charAt(0).toUpperCase() + containerId.slice(1)}</h4>`;
            data.forEach(item => {
                const label = document.createElement("label");
                label.innerHTML = `<input type='checkbox' value='${item[key]}'> ${item[key]}`;
                container.appendChild(label);
                container.appendChild(document.createElement("br"));
            });
        }

        function getSelectedValues(containerId) {
            return Array.from(document.querySelectorAll(`#${containerId} input:checked`))
                .map(cb => cb.value)
                .join(",");
        }

        async function salvarCliente() {
            const nome = document.getElementById("cliente").value;
            if (!nome) return alert("Nome do cliente √© obrigat√≥rio");
            
            const valores = {};
            ["nichos", "situacoes", "canais", "status"].forEach(tipo => {
                valores[tipo] = Array.from(document.querySelectorAll(`#${tipo} input[type=checkbox]:checked`))
                    .map(checkbox => checkbox.value).join(",");
            });
            
            let sql;
            if (clienteEditando) { // Se estamos editando
                sql = `UPDATE clientes SET cliente='${nome}', nichos='${valores.nichos}', situacoes='${valores.situacoes}', canais='${valores.canais}', status='${valores.status}' WHERE cliente='${clienteEditando}'`;
                clienteEditando = null; // Limpa ap√≥s edi√ß√£o
            } else { // Se estamos adicionando
                sql = `INSERT INTO clientes (cliente, nichos, situacoes, canais, status) VALUES ('${nome}', '${valores.nichos}', '${valores.situacoes}', '${valores.canais}', '${valores.status}')`;
            }

            await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodeURIComponent(sql)}`);
            document.getElementById("cliente").value = ""; // Limpa o campo do nome
            document.querySelectorAll("input[type=checkbox]").forEach(checkbox => checkbox.checked = false); // Limpa os checkboxes
            carregarClientes();
        }

        async function carregarClientes() {
			document.getElementById("loader").style.display = "flex"; 
            const response = await fetch("https://natalvalerio.pythonanywhere.com/api/sql?sql=select * from clientes");
            const clientes = await response.json();
            const tbody = document.getElementById("clientes");
            tbody.innerHTML = "";
            clientes.forEach(cliente => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${cliente.cliente}</td>
                    <td>${cliente.nichos}</td>
                    <td>${cliente.situacoes}</td>
                    <td>${cliente.canais}</td>
                    <td>${cliente.status}</td>
                    <td>
                        <button onclick="editarCliente('${cliente.cliente}', '${cliente.nichos}', '${cliente.situacoes}', '${cliente.canais}', '${cliente.status}')">Editar</button>
                        <button onclick="excluirCliente('${cliente.cliente}')">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
			document.getElementById("loader").style.display = "none"; 
        }

		async function excluirCliente(nome) {
			const confirmar = confirm(`Tem certeza que deseja excluir o cliente "${nome}"?`);
			if (confirmar) {
				const sql = `DELETE FROM clientes WHERE cliente='${nome}'`;
				await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodeURIComponent(sql)}`);
				carregarClientes();
			}
		}

        function editarCliente(nome, nichos, situacoes, canais, status) {
            document.getElementById("cliente").value = nome;
            marcarSelecionados("nichos", nichos);
            marcarSelecionados("situacoes", situacoes);
            marcarSelecionados("canais", canais);
            marcarSelecionados("status", status);
            clienteEditando = nome; // Define o cliente que est√° sendo editado
        }

        function marcarSelecionados(containerId, valores) {
            const valoresArray = valores.split(",");
            document.querySelectorAll(`#${containerId} input`).forEach(cb => {
                cb.checked = valoresArray.includes(cb.value);
            });
        }

        fetchOptions("https://natalvalerio.pythonanywhere.com/api/select/nichos", "nichos", "nichos");
        fetchOptions("https://natalvalerio.pythonanywhere.com/api/select/situacoes", "situacoes", "situacoes");
        fetchOptions("https://natalvalerio.pythonanywhere.com/api/select/canais", "canais", "canais");
        fetchOptions("https://natalvalerio.pythonanywhere.com/api/select/status", "status", "status");
        carregarClientes();
    </script>
</body>
</html>
