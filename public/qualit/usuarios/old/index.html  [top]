<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../img/icon.png" rel="shortcut icon" type="image/x-icon">
    <link href="../css/css.css" rel="stylesheet" type="text/css">
    <script src="../js/js.js"></script>
    <title>USU츼RIOS</title>
    <style>
        .container { display: flex; gap: 20px; }
        .column { flex: 1; }
        table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    </style>
</head>
<body>
    <header>
        <img src="img/logo.png" width="200" alt="Logo da Empresa">
        <h2>USU츼RIOS</h2>
    </header>

    <footer>
        <span id="dateTime"></span>
    </footer>

    <main>
        <BR/>
        <input type="text" id="Pesquisar" placeholder="游댍 Pesquisar..." onkeyup="Pesquisar()">
        <a href="javascript:window.history.back()"><button>VOLTAR 游댗</button></a>

        <div id="loader">
            <img src="../img/loading.gif" alt="Carregando...">
        </div>
        <BR><BR>

        Nome do Usu치rio: <input type="text" id="usuario" placeholder="Nome do Usu치rio" class="input_login">
        Senha: <input type="password" id="senha" placeholder="Senha" class="input_login">

        <h3>Selecione os Clientes</h3>
        <div id="clientesContainer"></div> <!-- Container para os checkboxes de clientes -->

        <button onclick="salvarUsuario()">Salvar Usu치rio</button>

        <h3>Usu치rios Cadastrados</h3>
        <table>
            <thead>
                <tr>
                    <th>Usu치rio</th>
                    <th>Senha</th>
                    <th>Clientes</th>
                    <th>A칞칫es</th>
                </tr>
            </thead>
            <tbody id="usuarios"></tbody>
        </table>

        <script>
            let usuarioEditando = null; // Vari치vel para controlar a edi칞칚o

            // Fun칞칚o para carregar os clientes dispon칤veis
            async function carregarClientes() {
                const response = await fetch("https://natalvalerio.pythonanywhere.com/api/sql?sql=select cliente from clientes");
                const clientes = await response.json();
                const container = document.getElementById("clientesContainer");
                container.innerHTML = "<h4>Clientes</h4>";
                clientes.forEach(cliente => {
                    const label = document.createElement("label");
                    label.innerHTML = `<input type='checkbox' value='${cliente.cliente}'> ${cliente.cliente}`;
                    container.appendChild(label);
                    container.appendChild(document.createElement("br"));
                });
            }

            // Fun칞칚o para obter os clientes selecionados
            function getClientesSelecionados() {
                return Array.from(document.querySelectorAll("#clientesContainer input:checked"))
                    .map(cb => cb.value)
                    .join(",");
            }

            // Fun칞칚o para salvar ou atualizar um usu치rio
            async function salvarUsuario() {
                const nome = document.getElementById("usuario").value;
                const senha = document.getElementById("senha").value;
                const clientes = getClientesSelecionados();

                if (!nome || !senha || !clientes) return alert("Todos os campos s칚o obrigat칩rios");

                let sql;
                if (usuarioEditando) { // Se estamos editando
                    sql = `UPDATE user SET usuario='${nome}', senha='${senha}', clientes='${clientes}' WHERE usuario='${usuarioEditando}'`;
                    usuarioEditando = null; // Limpa ap칩s edi칞칚o
                } else { // Se estamos adicionando
                    sql = `INSERT INTO user (usuario, senha, clientes) VALUES ('${nome}', '${senha}', '${clientes}')`;
                }

                await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodeURIComponent(sql)}`);
                document.getElementById("usuario").value = ""; // Limpa o campo do nome
                document.getElementById("senha").value = ""; // Limpa o campo da senha
                document.querySelectorAll("#clientesContainer input").forEach(checkbox => checkbox.checked = false); // Limpa os checkboxes
                carregarUsuarios();
            }

            // Fun칞칚o para carregar os usu치rios cadastrados
            async function carregarUsuarios() {
                document.getElementById("loader").style.display = "flex";
                const response = await fetch("https://natalvalerio.pythonanywhere.com/api/sql?sql=select * from user");
                const usuarios = await response.json();
                const tbody = document.getElementById("usuarios");
                tbody.innerHTML = "";
                usuarios.forEach(usuario => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${usuario.usuario}</td>
                        <td>${usuario.senha}</td>
                        <td>${usuario.clientes}</td>
                        <td>
                            <button onclick="editarUsuario('${usuario.usuario}', '${usuario.senha}', '${usuario.clientes}')">Editar</button>
                            <button onclick="excluirUsuario('${usuario.usuario}')">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById("loader").style.display = "none";
            }

            // Fun칞칚o para excluir um usu치rio
            async function excluirUsuario(nome) {
                const confirmar = confirm(`Tem certeza que deseja excluir o usu치rio "${nome}"?`);
                if (confirmar) {
                    const sql = `DELETE FROM user WHERE usuario='${nome}'`;
                    await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodeURIComponent(sql)}`);
                    carregarUsuarios();
                }
            }

            // Fun칞칚o para editar um usu치rio
            function editarUsuario(nome, senha, clientes) {
                document.getElementById("usuario").value = nome;
                document.getElementById("senha").value = senha;
                marcarClientesSelecionados(clientes); // Marca os checkboxes dos clientes
                usuarioEditando = nome; // Define o usu치rio que est치 sendo editado
            }

            // Fun칞칚o para marcar os checkboxes dos clientes selecionados
            function marcarClientesSelecionados(clientes) {
                const clientesArray = clientes.split(",");
                document.querySelectorAll("#clientesContainer input").forEach(checkbox => {
                    checkbox.checked = clientesArray.includes(checkbox.value);
                });
            }

            // Carrega os clientes e usu치rios ao iniciar a p치gina
            carregarClientes();
            carregarUsuarios();
        </script>
    </main>
</body>
</html>